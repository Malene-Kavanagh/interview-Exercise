name: Build and upload Docker image to cloud

'on':
  push:
    branches:
      - main
      
permissions:
  contents: read
  id-token: write
  
env:
  PROJECT_ID: myinterviewexercise
  REGION: us-west1
  SERVICE: github-work-service
  REPO: repo-main
  IMAGE: main
  GCS_KEY: '${{ secrets.GC_KEY_SERVICE }}'
  
jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
    
      - name: Checkout the repo
        uses: actions/checkout@v4
        
      - name: setting the variables
        run: >-
          echo "IMAGE-TAG=$REGION-docker.pkg.dev/$Project/$REPO/$IMAGE" >> $GITHUB_ENV
          
      - name: Authenticating to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GC_KEY_SERVICE }}'
          
      - name: Setting up the Cloud SDK
        uses: google-github-actions/deploy-cloudrun@v2
        
      - name: Docker authentication!
        run: 'gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet'
        
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: '${{ env.IMAGE_TAG }}'
          
      - name: Show output URL
        run: 'echo ${{ steps.deploy.outputs.url }}'
